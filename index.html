<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mesh Radio Artwork Gen</title>
  <style>
    @font-face { font-family: 'NeueHaasDisplayRoman'; src: url('fonts/NeueHaasDisplayRoman.ttf') format('truetype'); font-display: swap; }
    @font-face { font-family: 'NeueHaasDisplayThin';  src: url('fonts/NeueHaasDisplayThin.ttf')  format('truetype'); font-display: swap; }
    * { box-sizing: border-box; }
    body {
      background: #111;
      color: #fff;
      font-family: 'NeueHaasDisplayRoman', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      width: 100%;
      max-width: 400px;
      padding: 20px;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
      text-align: center;
      letter-spacing: 0.3px;
      font-weight: 600;
    }
    .step { display: none; margin-bottom: 1rem; }
    .step.active { display: block; }
    input[type="text"], textarea, select, button {
      width: 100%; font-size: 1rem; padding: 10px; margin-bottom: 10px; border-radius: 6px; border: none;
    }
    textarea { height: 120px; resize: vertical; }
    button { background: #1db954; color: #fff; cursor: pointer; font-weight: 600; }
    button:disabled { background: #555; cursor: not-allowed; }

    .toggle-group {
      display: flex; justify-content: space-between; margin-bottom: 10px;
    }
    .toggle-group label {
      flex: 1; text-align: center; background: #333; margin: 0 5px; padding: 10px; border-radius: 6px; cursor: pointer; user-select: none;
    }
    .toggle-group input { display: none; }
    .toggle-group input:checked + label { background: #1db954; }

    canvas { width: 100%; height: auto; margin-bottom: 10px; border-radius: 8px; background:#000; }

    /* Download/Share buttons side-by-side */
    .actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    #shareBtn { display: none; } /* only shown on iOS */
    @media(max-width:400px){ .container { padding: 10px; } }
  </style>
</head>
<body>
  <div class="container">
    <h1>mesh radio - art gen v1</h1>

    <!-- Step 1: Pick show -->
    <div id="step1" class="step active">
      <select id="showPicker" disabled><option>Loading shows…</option></select>
    </div>

    <!-- Step 2: Upload -->
    <div id="step2" class="step">
      <input type="file" id="uploadInput" accept="image/*" />
    </div>

    <!-- Step 3: Options -->
    <div id="step3" class="step">
      <div class="toggle-group">
        <input type="radio" id="formatSquare" name="format" value="square" checked /><label for="formatSquare">Post</label>
        <input type="radio" id="formatStory" name="format" value="story" /><label for="formatStory">Story</label>
      </div>
      <div class="toggle-group">
        <input type="radio" id="textWhite" name="textColor" value="white" checked /><label for="textWhite">White Text</label>
        <input type="radio" id="textBlack" name="textColor" value="black" /><label for="textBlack">Black Text</label>
      </div>
      <input type="text" id="customNoteInput" placeholder="Add Guest Here" />
      <button id="generateBtn" disabled>Generate Artwork</button>
      <button id="tracklistBtn" disabled>+ Tracklist</button>
    </div>

    <!-- Step 4: Canvas + Actions -->
    <div id="step4" class="step">
      <canvas id="artCanvas" width="1080" height="1080"></canvas>
      <div class="actions">
        <button id="downloadBtn" disabled>Download</button>
        <button id="shareBtn" disabled>Share</button>
      </div>
    </div>

    <!-- Step 5: Tracklist -->
    <div id="step5" class="step">
      <textarea id="tracklistInput" placeholder="Paste or type tracklist here…"></textarea>
      <button id="generateTracklistBtn" disabled>Overlay Tracklist</button>
    </div>
  </div>

  <script>
    let templateLayers = [], shows = [], uploadedImageDataURL = null;
    window.extraDJLineOffset = 0;

    // ---------- Loaders ----------
    async function loadFonts() {
      const f1 = new FontFace('NeueHaasDisplayRoman','url(fonts/NeueHaasDisplayRoman.ttf)');
      const f2 = new FontFace('NeueHaasDisplayThin','url(fonts/NeueHaasDisplayThin.ttf)');
      await Promise.all([f1.load(), f2.load()]);
      document.fonts.add(f1); document.fonts.add(f2);
    }

    async function loadTemplate() {
      const res = await fetch('template.json');
      if (!res.ok) throw new Error('template.json failed to load');
      templateLayers = await res.json();
    }

    async function loadShowData() {
      const picker = document.getElementById('showPicker');
      picker.disabled = true; picker.innerHTML = '<option>Loading shows…</option>';
      try {
        const res = await fetch('https://script.google.com/macros/s/AKfycbw3QgJtZXB48I0BUMpTE5Dlo2kqMReNuD4jbiEVBaB1z49bSgzEkAgixkjHxwTKRwY0/exec', { cache: 'no-store' });
        shows = await res.json();
      } catch (e) {
        console.error(e);
        picker.innerHTML = '<option disabled>Error loading shows</option>';
        return;
      }
      populateShows(shows);
    }

    function populateShows(list) {
      const picker = document.getElementById('showPicker');
      picker.innerHTML = '<option disabled selected>Select a show</option>';
      list.forEach((s,i) => {
        const d = new Date(s.Date);
        const label = `${d.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'})} - ${s['Now Playing']} (${s.DJ})`;
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = label;
        picker.appendChild(opt);
      });
      picker.disabled = false;
    }

    // ---------- Small utils ----------
    function drawImageCover(ctx, img, dx, dy, dWidth, dHeight) {
      const iw = img.naturalWidth, ih = img.naturalHeight;
      const r = Math.max(dWidth/iw, dHeight/ih);
      const nw = iw * r, nh = ih * r;
      const sx = (nw - dWidth) / 2;
      const sy = (nh - dHeight) / 2;
      ctx.drawImage(img, -sx + dx, -sy + dy, nw, nh);
    }

    function splitDjAndNote(raw) {
      const idx = raw.indexOf(' + ');
      if (idx === -1) return { dj: raw, note: '' };
      return { dj: raw.slice(0, idx), note: raw.slice(idx + 3) };
    }

    function drawDjWithNote(ctx, baseX, baseY, text, fs, maxWidth, color, isStoryWrap=false) {
      const { dj, note } = splitDjAndNote(text);
      const gap = ' + ';
      ctx.font = `${fs}px 'NeueHaasDisplayThin'`;
      const djW = ctx.measureText(dj).width;
      const gapW = ctx.measureText(gap).width;
      const noteW = ctx.measureText(note).width;
      const totalW = note ? (djW + gapW + noteW) : djW;

      if (note && isStoryWrap && totalW > maxWidth) {
        ctx.fillStyle = color;
        ctx.fillText(dj, baseX, baseY);
        const secondY = baseY + fs + 5;
        ctx.fillStyle = color;
        ctx.fillText('+ ', baseX, secondY);
        ctx.fillStyle = '#cfcfcf';
        ctx.fillText(note, baseX + ctx.measureText('+ ').width, secondY);
        return fs + 10;
      } else {
        let x = baseX;
        ctx.fillStyle = color;
        ctx.fillText(dj, x, baseY);
        x += djW;
        if (note) {
          ctx.fillStyle = color;
          ctx.fillText(gap, x, baseY);
          x += gapW;
          ctx.fillStyle = '#cfcfcf';
          ctx.fillText(note, x, baseY);
        }
        return 0;
      }
    }

    // ---------- Events ----------
    document.getElementById('showPicker').addEventListener('change', ()=>{
      document.getElementById('step2').classList.add('active');
    });

    document.getElementById('uploadInput').addEventListener('change', e => {
      const f = e.target.files[0]; if(!f) return;
      const fr = new FileReader();
      fr.onload = ev => {
        uploadedImageDataURL = ev.target.result;
        document.getElementById('step3').classList.add('active');
        document.getElementById('generateBtn').disabled = false;
        document.getElementById('tracklistBtn').disabled = false;
      };
      fr.readAsDataURL(f);
    });

    document.getElementById('generateBtn').addEventListener('click', () => {
      drawArtwork();
      document.getElementById('step4').classList.add('active');
    });

    document.getElementById('tracklistBtn').addEventListener('click', () => {
      document.getElementById('step5').classList.add('active');
    });

    document.getElementById('tracklistInput').addEventListener('input', e => {
      document.getElementById('generateTracklistBtn').disabled = !e.target.value.trim();
    });

    document.getElementById('generateTracklistBtn').addEventListener('click', () => {
      overlayTracklist();
      document.getElementById('step5').classList.remove('active');
    });

    // ---------- Main drawing ----------
    function drawArtwork() {
      const fmt = document.querySelector('input[name="format"]:checked').value;
      const textColor = document.querySelector('input[name="textColor"]:checked').value;
      const canvas = document.getElementById('artCanvas');
      canvas.width = 1080; canvas.height = fmt === 'story' ? 1920 : 1080;
      const ctx = canvas.getContext('2d'), cw = canvas.width, ch = canvas.height, extraH = ch - 1080;

      ctx.clearRect(0,0,cw,ch);
      ctx.fillStyle = '#000'; ctx.fillRect(0,0,cw,ch);

      const bg = new Image(); bg.src = uploadedImageDataURL;
      bg.onload = () => {
        ctx.save();
        ctx.translate(cw/2, ch/2);
        drawImageCover(ctx, bg, 0, 0, cw, ch);
        ctx.restore();

        let imgs = templateLayers.filter(l => l.type === 'image' && !(fmt === 'square' && /logo\s*white/i.test(l.name)));

        if (fmt === 'square') {
          const fade = imgs.find(l => l.name === 'Fade (img)');
          const line = imgs.find(l => l.name === 'Line + Site (img)');
          const others = imgs.filter(l => l.name !== 'Fade (img)' && l.name !== 'Line + Site (img)');
          imgs = [];
          if (fade) imgs.push(fade);
          if (line) imgs.push(line);
          imgs = imgs.concat(others);
        } else {
          imgs = imgs.sort((a, b) => {
            if (a.name === 'Fade (img)') return 1;
            if (b.name === 'Fade (img)') return -1;
            return 0;
          });
        }

        let loaded = 0;
        const targetCount = imgs.length;

        if (targetCount === 0) {
          drawTextAndOverlay(fmt, cw, ch, extraH, textColor);
          return;
        }

        imgs.forEach(l => {
          const img = new Image();
          img.src = (fmt==='story' && l.name==='Line + Site (img)') ? 'assets/line-+-site-story.png' : l.imageURL;
          img.onload = () => {
            ctx.save();
            ctx.globalAlpha = l.opacity || 1;
            if (fmt==='story' && l.name==='Line + Site (img)') {
              ctx.drawImage(img,0,0,cw,ch);
            } else {
              const x = l.x || 0;
              const y = (l.y || 0) + ((fmt==='story' && ['Fade (img)','Line + Site (img)'].includes(l.name)) ? extraH : 0);
              ctx.drawImage(img, x, y);
            }
            ctx.restore();
            if (++loaded === targetCount) drawTextAndOverlay(fmt, cw, ch, extraH, textColor);
          };
          img.onerror = () => {
            if (++loaded === targetCount) drawTextAndOverlay(fmt, cw, ch, extraH, textColor);
          };
        });
      };
    }

    function drawTextAndOverlay(fmt, cw, ch, extraH, textColor) {
      const ctx = document.getElementById('artCanvas').getContext('2d');
      const lines = templateLayers.filter(l=>l.type==='text');
      const show = shows[document.getElementById('showPicker').value];
      const gN = fmt==='story'?100:0, npN=fmt==='story'?50:0, dN=fmt==='story'?30:0, sM=fmt==='story'?1.8:1;

      window.extraDJLineOffset = 0;

      lines.forEach(l=>{
        const key = l.name.toLowerCase();
        let txt = '';
        if (key.includes('now playing')) {
          txt = show['Now Playing'];
        } else if (key === 'dj') {
          const note = document.getElementById('customNoteInput').value.trim();
          txt = show['DJ'] + (note ? ' + ' + note : '');
        } else if (key.includes('date')) {
          txt = new Date(show.Date).toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'}) + ' @ ' + show['A-B'];
        } else {
          return;
        }

        const fs = (l.size || 36) * sM;
        const fam = (key==='dj'||key.includes('date')) ? 'NeueHaasDisplayThin' : 'NeueHaasDisplayRoman';
        ctx.font = `${fs}px '${fam}'`;
        ctx.textBaseline = 'alphabetic';
        ctx.textAlign = 'left';

        const color = (textColor === 'black') ? '#000' : '#fff';
        let y = l.y + extraH + fs - gN;
        if (fmt==='story') {
          if (key.includes('now playing')) y -= npN;
          if (key.includes('date')) y += dN + (window.extraDJLineOffset || 0);
        }
        if (fmt==='square') y -= 17;

        const x = (l.x || 0) + 12;

        if (key === 'dj') {
          const maxWidth = cw - 100;
          const extra = drawDjWithNote(ctx, x, y, txt, fs, maxWidth, color, fmt === 'story');
          if (extra) window.extraDJLineOffset = extra;
        } else {
          ctx.fillStyle = color;
          ctx.fillText(txt, x, y);
        }
      });

      if (fmt === 'square') {
        const ov = new Image();
        ov.src = (textColor === 'black') ? 'assets/black-mode.png' : 'assets/logo-for-post.png';
        ov.onload = () => {
          const ctx = document.getElementById('artCanvas').getContext('2d');
          ctx.save();
          if (textColor === 'black') {
            ctx.globalAlpha = 1;
            ctx.globalCompositeOperation = 'source-over';
          } else {
            ctx.globalAlpha = 0.5;
            ctx.globalCompositeOperation = 'screen';
          }
          ctx.drawImage(ov, 0, 0, cw, ch);
          ctx.restore();
          enableActions();
        };
        ov.onerror = enableActions;
      } else {
        enableActions();
      }
    }

    // ---------- iPhone-safe download/share helpers ----------
    function isIOS() {
      const ua = navigator.userAgent || navigator.vendor || window.opera;
      const iOS = /iPad|iPhone|iPod/.test(ua);
      const iPadOS = (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      return iOS || iPadOS;
    }

    function canvasToBlob(canvas, type='image/png', quality=1) {
      return new Promise(resolve => {
        if (canvas.toBlob) {
          canvas.toBlob(b => resolve(b), type, quality);
        } else {
          const dataURL = canvas.toDataURL(type, quality);
          const byteString = atob(dataURL.split(',')[1]);
          const mimeString = dataURL.split(',')[0].split(':')[1].split(';')[0];
          const ab = new ArrayBuffer(byteString.length);
          const ia = new Uint8Array(ab);
          for (let i = 0; i < byteString.length; i++) ia[i] = byteString.charCodeAt(i);
          resolve(new Blob([ab], { type: mimeString }));
        }
      });
    }

    async function downloadCanvasIOSSafe(filename) {
      const canvas = document.getElementById('artCanvas');
      const blob = await canvasToBlob(canvas, 'image/png', 1);
      if (!blob) return;
      const url = URL.createObjectURL(blob);

      if (isIOS()) {
        // iOS: open in new tab; user can long-press → Save Image
        window.open(url, '_blank', 'noopener,noreferrer');
        setTimeout(() => URL.revokeObjectURL(url), 60000);
      } else {
        // Desktop: standard download
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 1000);
      }
    }

    async function shareCanvasIOSSafe(filename) {
      const canvas = document.getElementById('artCanvas');
      const blob = await canvasToBlob(canvas, 'image/png', 1);
      if (!blob) return;
      const file = new File([blob], filename, { type: 'image/png' });

      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({
            files: [file],
            title: 'Mesh Radio Artwork',
            text: filename
          });
          return;
        } catch (err) {
          // user cancelled or share failed – fall through
        }
      }
      // Fallback for iOS without canShare: open in new tab to save manually
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank', 'noopener,noreferrer');
      setTimeout(() => URL.revokeObjectURL(url), 60000);
    }

    // Enable/attach actions after render
    function enableActions() {
      const dlBtn = document.getElementById('downloadBtn');
      const shareBtn = document.getElementById('shareBtn');

      const show = shows[document.getElementById('showPicker').value] || {};
      const dj = (show['DJ'] || 'dj').replace(/[^a-z0-9]/gi, '_');
      const date = show.Date ? new Date(show.Date).toISOString().split('T')[0] : 'date';
      const format = document.querySelector('input[name="format"]:checked').value;
      const filename = `meshradio_${dj}_${date}_${format}.png`;

      dlBtn.disabled = false;
      dlBtn.onclick = () => downloadCanvasIOSSafe(filename);

      // Only show Share on iOS/iPadOS
      if (isIOS()) {
        shareBtn.style.display = 'inline-block';
        shareBtn.disabled = false;
        shareBtn.onclick = () => shareCanvasIOSSafe(filename);
      } else {
        shareBtn.style.display = 'none';
        shareBtn.disabled = true;
        shareBtn.onclick = null;
      }
    }

    // ---------- Tracklist overlay ----------
    function overlayTracklist() {
      const fmt = document.querySelector('input[name="format"]:checked').value;
      const textColor = document.querySelector('input[name="textColor"]:checked').value;
      const canvas = document.getElementById('artCanvas');
      const ctx = canvas.getContext('2d');
      const cw = canvas.width, ch = canvas.height;

      const bg = new Image(); bg.src = uploadedImageDataURL;
      bg.onload = () => {
        ctx.save();
        ctx.translate(cw/2, ch/2);
        ctx.filter = 'blur(30px)';
        drawImageCover(ctx, bg, 0, 0, cw + 60, ch + 60);
        ctx.restore();

        ctx.fillStyle='rgba(0,0,0,0.5)'; ctx.fillRect(0,0,cw,ch);

        let overlays = [];
        if (fmt === 'story') {
          overlays.push({ src: 'assets/line-+-site-story.png', alpha: 1, comp: 'screen' });
        } else {
          templateLayers
            .filter(l => l.type === 'image' && !(/logo\s*white/i.test(l.name)))
            .forEach(l => overlays.push({ src: l.imageURL, alpha: l.opacity||1, comp: 'screen' }));
          const logoSrc = (textColor==='black') ? 'assets/black-mode.png' : 'assets/tracklist-overlay-logo.png';
          overlays.push({ src: logoSrc, alpha: (textColor==='black')?1:0.5, comp: 'screen' });
        }

        let done = 0;
        const finish = () => {
          const show = shows[document.getElementById('showPicker').value];
          const color = (textColor === 'black') ? '#000' : '#fff';

          ctx.save();
          ctx.textAlign = 'center';
          ctx.textBaseline = 'top';

          ctx.fillStyle = color;
          ctx.font = '36px NeueHaasDisplayRoman';
          ctx.fillText(show['Now Playing'], cw/2, 20);

          const note = document.getElementById('customNoteInput').value.trim();
          const djLine = show['DJ'] + (note ? ' + ' + note : '');
          ctx.font = '28px NeueHaasDisplayThin';

          const { dj, note: noteOnly } = splitDjAndNote(djLine);
          const djW = ctx.measureText(dj).width;
          const plusW = ctx.measureText(' + ').width;
          const noteW = ctx.measureText(noteOnly).width;
          const totalW = noteOnly ? (djW + plusW + noteW) : djW;
          let startX = (cw - totalW) / 2;

          ctx.fillStyle = color;
          ctx.fillText(dj, startX, 20 + 36 + 5);
          startX += djW;
          if (noteOnly) {
            ctx.fillStyle = color;
            ctx.fillText(' + ', startX, 20 + 36 + 5);
            startX += plusW;
            ctx.fillStyle = '#cfcfcf';
            ctx.fillText(noteOnly, startX, 20 + 36 + 5);
          }

          ctx.fillStyle = color;
          ctx.font = '24px NeueHaasDisplayThin';
          const dateStr = new Date(show.Date).toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'}) + ' @ ' + show['A-B'];
          ctx.fillText(dateStr, cw/2, 20 + 36 + 5 + 28 + 5);
          ctx.restore();

          drawClippedTracklist(ctx, cw, ch);
          enableActions();
        };

        if (overlays.length === 0) { finish(); return; }

        overlays.forEach(o => {
          const img = new Image(); img.src = o.src;
          img.onload = () => {
            ctx.save(); ctx.globalAlpha=o.alpha; ctx.globalCompositeOperation=o.comp;
            ctx.drawImage(img,0,0,cw,ch); ctx.restore();
            if (++done === overlays.length) finish();
          };
          img.onerror = () => { if (++done === overlays.length) finish(); };
        });
      };
    }

    function drawClippedTracklist(ctx, cw, ch) {
      const lines = document.getElementById('tracklistInput').value
        .split('\n').map(l => l.trim()).filter(Boolean);
      if (!lines.length) return;

      let fontSize = 30;
      let lineHeight = Math.round(fontSize * 1.2);
      const maxBlockHeight = Math.floor(ch * 0.8);

      if (lines.length * lineHeight > maxBlockHeight) {
        fontSize = Math.floor((maxBlockHeight / lines.length) / 1.2);
        lineHeight = Math.round(fontSize * 1.2);
      }

      ctx.save();
      ctx.fillStyle = '#fff';
      ctx.font = `${fontSize}px NeueHaasDisplayRoman`;
      ctx.textAlign = 'left';
      ctx.textBaseline = 'top';

      const widths = lines.map(l => ctx.measureText(l).width);
      const maxW = Math.max(...widths);
      const startX = Math.round((cw - maxW) / 2);
      const totalH = lineHeight * lines.length;
      const startY = Math.round((ch - totalH) / 2);

      lines.forEach((l, i) => {
        ctx.fillText(l, startX, startY + i * lineHeight);
      });
      ctx.restore();
    }

    // ---------- Boot ----------
    window.addEventListener('load', () => {
      // Reveal Share only on iOS/iPadOS from the start (kept disabled until render)
      if (isIOS()) document.getElementById('shareBtn').style.display = 'inline-block';

      loadFonts()
        .then(() => loadTemplate())
        .then(loadShowData)
        .catch(err => console.error(err));
    });
  </script>
</body>
</html>
